{% extends 'menu/base.html' %}
{% block content %}
<h2>{% if edit %}Edit Order{% else %}New Order{% endif %}</h2>
<form method="POST" novalidate>
    {% csrf_token %}
    <div class="mb-3">
        {{ form.table_number.label_tag }}
        {{ form.table_number }}
        {% if form.table_number.errors %}
            <div class="text-danger">{{ form.table_number.errors }}</div>
        {% endif %}
    </div>

    <div id="order-items">
        {{ formset.management_form }}
        {% for form in formset %}
            <div class="order-item border p-3 my-2 bg-light rounded">
                {% for field in form.visible_fields %}
                    <div class="mb-3">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.errors %}
                            <div class="text-danger">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    <div class="d-flex gap-2 mb-3">
        <button type="button" class="btn btn-secondary" id="add-item">Add Another Dish</button>
        <button type="submit" class="btn btn-primary">{% if edit %}Update Order{% else %}Submit Order{% endif %}</button>
    </div>
</form>

<script>
    const addItemButton = document.getElementById('add-item');
    const orderItemsDiv = document.getElementById('order-items');
    let totalForms = document.querySelector('#id_form-TOTAL_FORMS');

    addItemButton.addEventListener('click', () => {
        const formCount = parseInt(totalForms.value);
        const newForm = orderItemsDiv.querySelector('.order-item').cloneNode(true);

        // Clear values in the new form
        newForm.querySelectorAll('input, select, textarea').forEach(input => {
            if (input.type !== 'hidden') {
                input.value = '';
            }
        });

        // Update form index
        newForm.innerHTML = newForm.innerHTML.replace(/form-(\d)-/g, `form-${formCount}-`);
        orderItemsDiv.appendChild(newForm);
        totalForms.value = formCount + 1;
    });
</script>
{% endblock %}
